<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Fórum</title>    
</head>

<body>
    <body>
    <header>
        <div class="logo">
            <a href="index.html"><img src="imgs/logo2.png" alt=""></a> 
        </div>
        
        <nav>
            <ul class="menu">
                <li><a href="sobre-o-livro.html">Sobre o Livro</a></li>
                <li><a href="sobre-mim.html">Sobre o Autor</a></li>
                <li><a href="forum.html">Forum</a></li>
            </ul>
        </nav>
        
        <div class="acessar">
            <span id="b_usuario">usuário</span>
        </div>
        <div>
            <img src="imgs/user.png" alt="" style="width: 100px; height: 60px; padding-top: 5px; padding-left: 40px;">
        </div>
        <div>
            <img onclick="exibirMenu()" src="imgs/sandwich.png" alt=""
                 style="width: 70px; height: 40px; padding-top: 5px; padding-left: 30px;">
        </div>
        <div class="menu_lateral" id="menu_lateral">
            <ul class="menu">
                <li><a href="sobre-mim.html">Configurações</a></li>
                <li><a href="painel.html">Verificar Painel</a></li>
                <li onclick="sair()"><a href="index.html">Sair</a></li>
            </ul>
        </div>
    </header>

    <main>

        <div class="container">

            <div class="forum">
                <h2>Criar novo tópico</h2>

                <span>Título</span> <br>
                <input id="titulo_forum"> <br>

                <span>Descrição</span> <br>
                <textarea id="descricao_forum"></textarea> <br>

                <button class="publicar" onclick="criarPostagem()">
                    Publicar
                </button>

                <h2>Tópicos do Fórum</h2>

                <div id="lista_forum"></div>
            </div>

            

        </div>

    </main>

    <footer>
            <div class="redes-sociais" id="autor">
                <a href="https://euaospedacos.substack.com/"><img src="imgs/substack.png" width="50px" height="50px " alt=""></a>
                <a href="https://github.com/jortieke"><img src="imgs/git.png" width="100px" height="100px" alt=""></a>
                <img src="imgs/foto-joao.jpg"  width="200px" height="200px" alt="">
                <a href="https://www.linkedin.com/in/jortieke/"><img src="imgs/linkedin.png" width="100px" height="100px" alt=""></a>
                <a href="https://lattes.cnpq.br/3030602547312886"><img src="imgs/lattes.png" width="50px" height="50px" alt=""></a>
            </div>
            <span>© 2025. "Eu, aos pedaços". Todos os direitos reservados.</span>
    </footer>

</body>


</html>


<script>
b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
if (sessionStorage.ID_USUARIO == undefined) {
        alert("Você precisa estar logado para acessar esta página.");
        window.location = "/login.html"; 
    } 

    var menu = false;
    
    function exibirMenu(){
        if (menu == false) {
            menu = true;
            menu_lateral.style.display = "flex";
        } else { 
            menu = false;
            menu_lateral.style.display = "none";
        }
    }

    function sair(){
        sessionStorage.clear();
        window.location.href = "login.html";
    }
    
window.onload = () => {
    carregarPosts();
};


    function carregarPosts() {
        fetch("/forum/listar")
            .then(res => res.json())
            .then(lista => {
                var area = document.getElementById("lista_forum");
                area.innerHTML = "";

                lista.forEach(post => {
                    area.innerHTML += montarPostHTML(post);
                    registrarVisualizacao(post.idForum);
                    verificarCurtida(post.idForum);
                    atualizarCurtidas(post.idForum);
                    atualizarVisualizacoes(post.idForum);
                });
            });
    }


function montarPostHTML(post) {
    var dataFormatada = new Date(post.dtPostagem).toLocaleString("pt-BR");

    return `
        <div class="post">
            <h3>${post.titulo}</h3>
            <hr>
            <p>${post.descricao}</p>
            <small>Postado em: ${dataFormatada}</small> <br>
            <small>Postado por: ${post.autor}</small>

            <div style="margin-top: 10px;">
            </div>
        </div>
         <button class="curtir" onclick="curtir(${post.idForum})" id="btnCurtir_${post.idForum}">
                    Curtir
                </button>
                <span id="curtidas_${post.idForum}">0</span> curtidas |
                <span id="views_${post.idForum}">0</span> visualizações
    `;
}

    function criarPostagem() {
        var idUsuario = sessionStorage.ID_USUARIO;
        var titulo = document.getElementById("titulo_forum").value;
        var descricao = document.getElementById("descricao_forum").value;

        fetch("/forum/criar", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ titulo, descricao, idUsuario })
        })
        .then(res => {
            if (!res.ok) throw "Erro ao criar post";
            return res.json();
        })
        .then(() => {
            carregarPosts();
            carregarKpis();
        });
    }


    function curtir(idForum) {
        var idUsuario = sessionStorage.ID_USUARIO;

        fetch(`/curtida/verificar/${idUsuario}/${idForum}`)
        .then(r => r.json())
        .then(res => {
            if (res.curtido) {
                return fetch("/curtida/remover", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ fkUsuario: idUsuario, fkForum: idForum })
                });
            } else {
                return fetch("/curtida/curtir", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ fkUsuario: idUsuario, fkForum: idForum })
                });
            }
        })
        .then(() => {
            atualizarCurtidas(idForum);
            verificarCurtida(idForum);
            carregarKpis();
        });
    }


    function verificarCurtida(idForum) {
        var idUsuario = sessionStorage.ID_USUARIO;

        fetch(`/curtida/verificar/${idUsuario}/${idForum}`)
        .then(r => r.json())
        .then(res => {
            var btn = document.getElementById(`btnCurtir_${idForum}`);
            btn.innerHTML = res.curtido ? `
            <img src="imgs/liked.png" style="width: 20px; height: 20px;" alt="">` 
            : `<img src="imgs/not-liked.png" style="width: 20px; height: 20px;" alt="">`;
        });
    }


    function atualizarCurtidas(idForum) {
        fetch(`/curtida/contar/${idForum}`)
            .then(r => r.json())
            .then(res => {
                document.getElementById(`curtidas_${idForum}`).innerHTML = res.totalCurtidas;
            });
    }


    function registrarVisualizacao(idForum) {
        var fkUsuario = sessionStorage.ID_USUARIO;

        fetch("/visualizacao/registrar", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ fkUsuario, fkForum: idForum })
        })
        .then(() => atualizarVisualizacoes(idForum));
    }

    function atualizarVisualizacoes(idForum) {
        fetch(`/visualizacao/contar/${idForum}`)
            .then(r => r.json())
            .then(res => {
                document.getElementById(`views_${idForum}`).innerHTML = res.totalVisualizacoes;
            });
    }

</script>