<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <title>Painel</title>
</head>

<body>
    <header  id="logout" style="display: flex;">
        <div class="logo">
            <a href="index.html"><img src="imgs/logo2.png" alt=""></a> 
        </div>
        
        <nav>
            <ul class="menu">
                <li><a href="sobre-o-livro.html">Sobre o Livro</a></li>
                <li><a href="sobre-mim.html">Sobre o Autor</a></li>
                <li><a href="forum.html">Forum</a></li>
            </ul>
        </nav>
        
        <div class="acessar">
            <span id="b_usuario">usuário</span>
        </div>
        <div>
            <img src="imgs/user.png" alt="" style="width: 100px; height: 60px; padding-top: 5px; padding-left: 40px;">
        </div>
        <div>
            <img onclick="exibirMenu()" src="imgs/sandwich.png" alt=""
                 style="width: 70px; height: 40px; padding-top: 5px; padding-left: 30px;">
        </div>
        <div class="menu_lateral" id="menu_lateral">
            <ul class="menu">
                <li><a href="sobre-mim.html">Configurações</a></li>
                <li><a href="painel.html">Verificar Painel</a></li>
                <li onclick="sair()"><a href="index.html">Sair</a></li>
            </ul>
        </div>
    </header>
    <main>
        <div class="container-dash">
        
            <div class="card-kpi">
                <h3 id="kpi_titulo">Capítulos Lidos</h3>
                <p id="kpi_capitulos">0/110</p>
            </div>

        
            <div class="card-kpi">
                <h3>Postagens no Fórum</h3>
                <p id="kpi_postagens">0</p>
            </div>

            <div class="card-kpi">
                <h3>Curtidas Recebidas</h3>
                <p id="kpi_curtidas_forum">0</p>   
            </div>

            <div class="card-kpi">
                <h3>Visualizações Recebidas</h3>
                <p id="kpi_visualizacoes_forum">0</p>
            </div>
        </div>

        <div class="container-dash">
                <div class="dash">
                    <canvas id="bar"></canvas>
                </div>

                <div id="caixa_cap">
                    <div id="capitulos"></div>
                </div>
        </div>

       </div>
        
        <footer>
            <div class="redes-sociais" id="autor">
                <a href="https://euaospedacos.substack.com/"><img src="imgs/substack.png" width="50px" height="50px " alt=""></a>
                <a href="https://github.com/jortieke"><img src="imgs/git.png" width="100px" height="100px" alt=""></a>
                <img src="imgs/foto-joao.jpg"  width="200px" height="200px" alt="">
                <a href="https://www.linkedin.com/in/jortieke/"><img src="imgs/linkedin.png" width="100px" height="100px" alt=""></a>
                <a href="https://lattes.cnpq.br/3030602547312886"><img src="imgs/lattes.png" width="50px" height="50px" alt=""></a>
            </div>
            <span>© 2025. "Eu, aos pedaços". Todos os direitos reservados.</span>
        </footer>
    </main>
</body>



</html>

<script>

b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    if (sessionStorage.ID_USUARIO == undefined) {
            alert("Você precisa estar logado para acessar esta página.");
            window.location = "/login.html"; 
        }

    var menu = false;

    function exibirMenu(){
        if (menu == false) {
            menu = true;
            menu_lateral.style.display = "flex";
        } else { 
            menu = false;
            menu_lateral.style.display = "none";
        }
    }

    function sair(){
        sessionStorage.clear();
        window.location.href = "login.html";
    }

    var chartCapitulos = null;

    window.onload = () => {
        montarCapitulos();
        preencherCapitulosMarcados();
        atualizarKpiCapitulos();
        carregarKpis();
    };

    function montarCapitulos() {
        var blocos = [
            ["Parte VI", 101, 110],
            ["Parte V", 81, 100],
            ["Parte IV", 61, 80],
            ["Parte III", 41, 60],
            ["Parte II", 21, 40],
            ["Parte I", 1, 20]
        ];

        var blocoChecagem = "";

        for (var i = 0; i < blocos.length; i++) {
            var titulo = blocos[i][0];
            var inicio = blocos[i][1];
            var fim = blocos[i][2];

            blocoChecagem += `<details>`;
            blocoChecagem += `<summary> ${titulo} (Cap. ${inicio} a ${fim})</summary>`;


            for (var c = inicio; c <= fim; c++) {
                blocoChecagem += `<label><input type='checkbox' id='cap${c}'> Cap. ${c} </label>`;
            }

            blocoChecagem += `</details>`;
        }

        blocoChecagem += `<button id='botao-salvar' onclick='salvarCapitulos()'>Salvar Leitura</button>`;

        document.getElementById("capitulos").innerHTML = blocoChecagem;
    }


    function preencherCapitulosMarcados() {
        var idUsuario = sessionStorage.ID_USUARIO;

        fetch(`/leitura/listar/${idUsuario}`) 
            .then(res => res.json())
            .then(lista => {
                lista.forEach(reg => {
                    var el = document.getElementById("cap" + reg.capitulo);
                    if (el) el.checked = true;
                });
            });
    }


    function atualizarKpiCapitulos() {
        var idUsuario = sessionStorage.ID_USUARIO;

        fetch(`/leitura/listar/${idUsuario}`, { cache: "no-store" })
        .then(r => r.json())
        .then(lista => {
            document.getElementById("kpi_capitulos").innerText = `${lista.length}/110`;

            var dadosProcessados = processarDadosPorMes(lista);
            atualizarGraficoBarra(dadosProcessados);
        })
        .catch(err => console.error("Erro ao atualizar:", err));
    }

    function carregarKpis() {
        var idUsuario = sessionStorage.ID_USUARIO;

        fetch(`/forum/kpis/${idUsuario}`)
        .then(r => r.json())
        .then(resposta => {
            document.getElementById("kpi_postagens").innerHTML = resposta.postagens;
            document.getElementById("kpi_curtidas_forum").innerHTML = resposta.curtidas;
            document.getElementById("kpi_visualizacoes_forum").innerHTML = resposta.visualizacoes;
        })
        .catch(e => console.log(e));
    }

    function salvarCapitulos() {
        var idUsuario = sessionStorage.ID_USUARIO;
        var lidos = [];

        for (var i = 1; i <= 110; i++) {
            var c = document.getElementById("cap" + i);
            if (c && c.checked) lidos.push(i);
        }

        fetch("/leitura/salvar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                idUsuario: idUsuario,
                capitulos: lidos
            })
        })
        .then(res => {
            if (!res.ok) throw new Error("Erro ao salvar capítulos");
            return res.json();
        })
        .then(() => {
            alert("Capítulos salvos com sucesso!");
            atualizarKpiCapitulos();
        })
        .catch(err => console.error(err));
    }

    

    function processarDadosPorMes(dadosBrutos) {
    var labels = [];
    var contagens = [];
    var nomesMeses = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho",
                      "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

    for (var i = 0; i < dadosBrutos.length; i++) {
        var reg = dadosBrutos[i];

        if (!reg.dtLeitura) continue;

        var data = new Date(reg.dtLeitura);
        var mes = data.getMonth();
        var ano = data.getFullYear();

        var chave = nomesMeses[mes] + "/" + ano;

        var indice = -1;
        for (var j = 0; j < labels.length; j++) {
            if (labels[j] === chave) {
                indice = j;
                break;
            }
        }

        if (indice === -1) {
            labels.push(chave);
            contagens.push(1);
        } else {
            contagens[indice]++;
        }
    }

    return {
        labels: labels,
        data: contagens
    };
}



    function atualizarGraficoBarra(dados) {
        var ctx = document.getElementById('bar').getContext('2d');

        if (chartCapitulos) chartCapitulos.destroy();

        var cores= ['#F7F0E4', '#702424', '#10491B'];

        chartCapitulos = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dados.labels,
                datasets: [{
                    label: "Capítulos lidos",
                    data: dados.data,
                    backgroundColor: dados.labels.map((_, i) => cores[i % cores.length]),
                    borderColor: "##333333",
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: "Capítulos Lidos por Mês",
                        font: { size: 16 }
                    }
                },
                scales: {
                    x: { title: { display: true, text: "Mês/Ano" }},
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: "Quantidade" },
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
    }

</script>
